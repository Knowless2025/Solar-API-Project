<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดแสดงการใช้พลังงาน</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Kanit font to the body */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Custom styles for Chart.js tooltips and legends */
        .chart-container {
            position: relative;
            margin: auto;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white text-center">ภาพรวมการใช้พลังงานไฟฟ้า (อาคารผลิต)</h1>
            <p class="text-center text-gray-400 mt-1">อัปเดตล่าสุด: <span id="last-updated"></span></p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Top-Left: Main Meter kWh -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-white">ค่าพลังงานรวม (อาคารผลิต)</h2>
                    <p class="text-gray-400">Main Meter (Production Building)</p>
                </div>
                <div class="text-center my-4">
                    <span class="text-6xl font-bold text-cyan-400">12,580.75</span>
                    <span class="text-2xl text-gray-300 ml-2">kWh</span>
                </div>
                <div class="text-sm text-center text-red-400">
                    <span>▲ 2.5%</span>
                    <span class="text-gray-400">เทียบกับเมื่อวาน</span>
                </div>
            </div>

            <!-- Top-Right: Nested Donut Chart for Internal Consumption -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                <div class="text-center">
                    <h2 class="text-xl font-semibold text-white mb-2">เปรียบเทียบสัดส่วนการใช้พลังงาน</h2>
                    <p class="text-gray-400 text-center mb-2">เดือนปัจจุบัน (วงนอก) vs เดือนก่อน (วงใน)</p>
                    <!-- Summary of change vs last month -->
                    <div id="donut-chart-summary" class="text-sm mb-3">
                        <!-- Content generated by JavaScript -->
                    </div>
                </div>
                <div class="chart-container flex-grow" style="min-height: 220px;">
                    <canvas id="internalConsumptionPieChart"></canvas>
                </div>
            </div>

            <!-- Middle: Individual Machine Consumption (Spans full width) -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">ค่าพลังงานของเครื่องจักร (รายเครื่อง)</h2>
                <!-- This grid will be populated by JavaScript -->
                <div id="machine-cards-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
            </div>

            <!-- Bottom: Bar Chart (Spans full width) -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">5 อันดับเครื่องจักรที่ใช้พลังงานสูงสุด (รายวัน)</h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="dailyUsageBarChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Mock Data ---
        const internalConsumptionData = {
            currentMonth: {
                machinery: 7040,
                office: 3100,
                utility: 2440.75,
            },
            previousMonth: {
                machinery: 6800,
                office: 3250,
                utility: 2300,
            }
        };

        // Data for individual machine cards including production data for efficiency calculation
        const machineData = [
            { name: 'CNC-01', currentKwh: 1120, previousDayKwh: 1085, productionKg: 5500 },
            { name: 'Injection-A', currentKwh: 2450, previousDayKwh: 2510, productionKg: 12000 },
            { name: 'Welding-R5', currentKwh: 890, previousDayKwh: 890, productionKg: 4000 },
            { name: 'Assembly-L2', currentKwh: 750, previousDayKwh: 780, productionKg: 15000 },
            { name: 'Painting-01', currentKwh: 1830, previousDayKwh: 1755, productionKg: 9000 },
        ];

        const barChartData = [
            // Daily usage data for top 5 machines
            { machine: 'Injection-A', kwh: 98 },
            { machine: 'Painting-01', kwh: 75 },
            { machine: 'CNC-01', kwh: 65 },
            { machine: 'Welding-R5', kwh: 44 },
            { machine: 'Assembly-L2', kwh: 32 },
        ];

        // --- Utility Functions ---
        function updateTimestamp() {
            const now = new Date();
            const formattedTime = now.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-updated').textContent = formattedTime;
        }

        function populateMachineCards() {
            const grid = document.getElementById('machine-cards-grid');
            if (!grid) return;
            grid.innerHTML = ''; // Clear existing content

            machineData.forEach(machine => {
                const change = machine.previousDayKwh > 0 ? ((machine.currentKwh - machine.previousDayKwh) / machine.previousDayKwh) * 100 : 0;
                const isIncrease = change > 0;
                const isDecrease = change < 0;
                const changeColor = isIncrease ? 'text-red-400' : (isDecrease ? 'text-green-400' : 'text-gray-400');
                const changeIcon = isIncrease ? '▲' : (isDecrease ? '▼' : '–');
                const formattedChange = Math.abs(change).toFixed(1);

                // Efficiency (kWh/Kg) calculation and tooltip generation
                let efficiencyTooltipHTML = '';
                if (machine.productionKg && machine.productionKg > 0) {
                    const efficiency = machine.currentKwh / machine.productionKg;
                    efficiencyTooltipHTML = `
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max invisible group-hover:visible bg-gray-600 text-white text-xs rounded-lg py-1 px-3 z-10">
                            ประสิทธิภาพ: ${efficiency.toFixed(2)} kWh/Kg
                            <svg class="absolute text-gray-600 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        </div>
                    `;
                }

                const cardHTML = `
                    <div class="bg-gray-700 p-4 rounded-lg text-center flex flex-col justify-between h-full">
                        <div>
                            <h3 class="font-semibold text-white">${machine.name}</h3>
                            <div class="relative group inline-block my-1 cursor-pointer">
                                <p class="text-2xl font-bold text-amber-400">${new Intl.NumberFormat('th-TH').format(machine.currentKwh)}</p>
                                <p class="text-sm text-gray-400 -mt-1">kWh</p>
                                ${efficiencyTooltipHTML}
                            </div>
                        </div>
                        <div class="text-sm mt-2 ${changeColor}">
                            <span>${changeIcon} ${formattedChange}%</span>
                            <span class="text-gray-500"> เทียบกับเมื่อวาน</span>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHTML;
            });
        }
        
        function calculateAndDisplayDonutSummary() {
            const summaryContainer = document.getElementById('donut-chart-summary');
            if (!summaryContainer) return;

            const currentTotal = Object.values(internalConsumptionData.currentMonth).reduce((a, b) => a + b, 0);
            const previousTotal = Object.values(internalConsumptionData.previousMonth).reduce((a, b) => a + b, 0);

            if (previousTotal === 0) return; // Avoid division by zero

            const change = ((currentTotal - previousTotal) / previousTotal) * 100;
            const isIncrease = change > 0;
            const isDecrease = change < 0;

            const changeColor = isIncrease ? 'text-red-400' : (isDecrease ? 'text-green-400' : 'text-gray-400');
            const changeIcon = isIncrease ? '▲' : (isDecrease ? '▼' : '–');
            const formattedChange = Math.abs(change).toFixed(1);

            summaryContainer.innerHTML = `
                <span class="${changeColor} font-semibold">
                    ${changeIcon} ${formattedChange}%
                </span>
                <span class="text-gray-400">เทียบกับเดือนก่อน</span>
            `;
        }


        // --- Chart Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateTimestamp();
            populateMachineCards();
            calculateAndDisplayDonutSummary();
            setInterval(updateTimestamp, 1000);

            // 1. Nested Donut Chart: Internal Consumption Ratio
            const pieCtx = document.getElementById('internalConsumptionPieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['เครื่องจักร (Machinery)', 'สำนักงาน (Office)', 'Utility'],
                    datasets: [
                        {
                            label: 'เดือนปัจจุบัน',
                            data: Object.values(internalConsumptionData.currentMonth),
                            backgroundColor: [
                                'rgba(34, 211, 238, 0.8)', // cyan-400
                                'rgba(99, 102, 241, 0.8)', // indigo-500
                                'rgba(139, 92, 246, 0.8)', // violet-500
                            ],
                            borderColor: '#1f2937' // bg-gray-800
                        },
                        {
                            label: 'เดือนก่อน',
                            data: Object.values(internalConsumptionData.previousMonth),
                             backgroundColor: [
                                'rgba(251, 191, 36, 0.7)', // amber-400
                                'rgba(59, 130, 246, 0.7)', // blue-500
                                'rgba(16, 185, 129, 0.7)'  // emerald-500
                            ],
                            borderColor: '#1f2937' // bg-gray-800
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#D1D5DB', // gray-300
                                font: { family: "'Kanit', sans-serif" }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    let datasetLabel = context.dataset.label || '';
                                    let dataLabel = context.label || '';
                                    return ` ${datasetLabel} - ${dataLabel}: ${new Intl.NumberFormat('th-TH').format(value)} kWh (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Bar Chart: Daily Top Usage
            const barCtx = document.getElementById('dailyUsageBarChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barChartData.map(d => d.machine),
                    datasets: [{
                        label: 'การใช้พลังงาน (kWh)',
                        data: barChartData.map(d => d.kwh),
                        backgroundColor: 'rgba(251, 191, 36, 0.8)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#D1D5DB', font: { family: "'Kanit', sans-serif" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#D1D5DB', font: { family: "'Kanit', sans-serif" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        });
    </script>
</body>
</html>



