<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดแสดงการใช้พลังงาน</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Kanit font to the body */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Custom styles for Chart.js tooltips and legends */
        .chart-container {
            position: relative;
            margin: auto;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8">

    <!-- Main Dashboard View -->
    <div id="main-dashboard" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white text-center">ภาพรวมการใช้พลังงานไฟฟ้า (อาคารผลิต)</h1>
            <p class="text-center text-gray-400 mt-1">อัปเดตล่าสุด: <span id="last-updated"></span></p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Top-Left: Main Meter kWh -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-white">ค่าพลังงานรวม (อาคารผลิต)</h2>
                    <p class="text-gray-400">Main Meter (Production Building)</p>
                </div>
                <!-- Main value with tooltip -->
                <div class="text-center my-4 relative group cursor-pointer">
                    <span class="text-6xl font-bold text-cyan-400">12,580.75</span>
                    <span class="text-2xl text-gray-300 ml-2">kWh</span>
                    <!-- Tooltip for main value -->
                    <div id="main-value-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max invisible group-hover:visible bg-gray-600 text-white text-sm rounded-lg py-2 px-4 z-10 text-left shadow-lg">
                        <!-- Content generated by JavaScript -->
                    </div>
                </div>
                <div class="text-sm text-center text-red-400">
                    <span>▲ 2.5%</span>
                    <span class="text-gray-400">เทียบกับเมื่อวาน</span>
                </div>
            </div>

            <!-- Top-Right: Nested Donut Chart for Internal Consumption -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                <div class="text-center">
                    <h2 class="text-xl font-semibold text-white mb-2">เปรียบเทียบสัดส่วนการใช้พลังงาน</h2>
                    <p class="text-gray-400 text-center mb-2">เดือนปัจจุบัน (วงนอก) vs เดือนก่อน (วงใน)</p>
                    <div id="donut-chart-summary" class="text-sm mb-3"></div>
                </div>
                <div class="chart-container flex-grow" style="min-height: 220px;">
                    <canvas id="internalConsumptionPieChart"></canvas>
                </div>
            </div>

            <!-- Middle: Individual Machine Consumption (Spans full width) -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">ค่าพลังงานของเครื่องจักร (รายเครื่อง)</h2>
                <div id="machine-cards-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>

            <!-- Bottom: Bar Chart (Spans full width) -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">5 อันดับเครื่องจักรที่ใช้พลังงานสูงสุด (รายวัน)</h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="dailyUsageBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Detail View (Hidden by default) -->
    <div id="machine-detail-view" class="max-w-7xl mx-auto hidden">
        <!-- Content will be generated by JavaScript -->
    </div>


    <script>
        // --- Mock Data ---
        const mainMeterData = {
            totalKwh: 12580.75, peakDemandKw: 450, dailyTargetKwh: 13000
        };
        const internalConsumptionData = {
            currentMonth: { machinery: 7040, office: 3100, utility: 2440.75 },
            previousMonth: { machinery: 6800, office: 3250, utility: 2300 }
        };
        // Expanded machine data with details for drill-down view
        const machineData = [
            { name: 'CNC-01', currentKwh: 1120, previousDayKwh: 1085, productionKg: 5500,
              details: { volts: [380.5, 381.2, 379.9], amps: [15.2, 15.5, 15.1], pf: 0.92, status: 'Running', temperature: 55.2, vibration: 0.85 } },
            { name: 'Injection-A', currentKwh: 2450, previousDayKwh: 2510, productionKg: 12000,
              details: { volts: [380.1, 380.9, 380.5], amps: [35.8, 36.1, 35.9], pf: 0.95, status: 'Running', temperature: 62.5, vibration: 1.12 } },
            { name: 'Welding-R5', currentKwh: 890, previousDayKwh: 890, productionKg: 4000,
              details: { volts: [379.8, 380.2, 380.0], amps: [12.1, 12.0, 12.2], pf: 0.89, status: 'Idle', temperature: 40.1, vibration: 0.55 } },
            { name: 'Assembly-L2', currentKwh: 750, previousDayKwh: 780, productionKg: 15000,
              details: { volts: [381.0, 381.1, 381.4], amps: [8.5, 8.6, 8.5], pf: 0.91, status: 'Running', temperature: 45.8, vibration: 0.65 } },
            { name: 'Painting-01', currentKwh: 1830, previousDayKwh: 1755, productionKg: 9000,
              details: { volts: [380.7, 380.3, 380.6], amps: [25.3, 25.1, 25.5], pf: 0.93, status: 'Error', temperature: 58.3, vibration: 2.5 } }
        ];
        const barChartData = [
            { machine: 'Injection-A', kwh: 98 }, { machine: 'Painting-01', kwh: 75 }, { machine: 'CNC-01', kwh: 65 },
            { machine: 'Welding-R5', kwh: 44 }, { machine: 'Assembly-L2', kwh: 32 }
        ];
        
        const ELECTRICITY_RATE_THB_PER_KWH = 4.5;
        const CO2_EMISSION_FACTOR_KG_PER_KWH = 0.498;

        // --- View Management Functions ---
        function showDashboard() {
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('machine-detail-view').classList.add('hidden');
        }

        function showMachineDetails(machineName) {
            const machine = machineData.find(m => m.name === machineName);
            if (!machine) return;

            const detailView = document.getElementById('machine-detail-view');
            
            const statusColor = machine.details.status === 'Running' ? 'text-green-400' : (machine.details.status === 'Idle' ? 'text-yellow-400' : 'text-red-500');

            detailView.innerHTML = `
                <header class="mb-8 flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-white">รายละเอียดเครื่องจักร: ${machine.name}</h1>
                    <button onclick="showDashboard()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        &larr; กลับไปหน้าหลัก
                    </button>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Electrical Data Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">ข้อมูลไฟฟ้า</h2>
                        <ul class="space-y-3 text-lg">
                            <li class="flex justify-between"><span>Voltage (L1-N, L2-N, L3-N):</span> <span class="font-bold text-cyan-400">${machine.details.volts.join(' / ')} V</span></li>
                            <li class="flex justify-between"><span>Current (L1, L2, L3):</span> <span class="font-bold text-cyan-400">${machine.details.amps.join(' / ')} A</span></li>
                            <li class="flex justify-between"><span>Power Factor (PF):</span> <span class="font-bold text-cyan-400">${machine.details.pf}</span></li>
                        </ul>
                    </div>
                    <!-- Condition Monitoring Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">ข้อมูลสภาวะเครื่องจักร</h2>
                        <ul class="space-y-3 text-lg">
                            <li class="flex justify-between"><span>สถานะ:</span> <span class="font-bold ${statusColor}">${machine.details.status}</span></li>
                            <li class="flex justify-between"><span>อุณหภูมิมอเตอร์:</span> <span class="font-bold text-amber-400">${machine.details.temperature}°C</span></li>
                            <li class="flex justify-between"><span>แรงสั่นสะเทือน:</span> <span class="font-bold text-amber-400">${machine.details.vibration} g</span></li>
                        </ul>
                    </div>
                    <!-- Production Info Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">ข้อมูลการผลิต</h2>
                         <ul class="space-y-3 text-lg">
                            <li class="flex justify-between"><span>ปริมาณผลิตวันนี้:</span> <span class="font-bold text-lime-400">${machine.productionKg.toLocaleString('th-TH')} Kg</span></li>
                            <li class="flex justify-between"><span>ประสิทธิภาพ:</span> <span class="font-bold text-lime-400">${(machine.currentKwh / machine.productionKg).toFixed(2)} kWh/Kg</span></li>
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById('main-dashboard').classList.add('hidden');
            detailView.classList.remove('hidden');
        }

        // --- Utility Functions ---
        function updateTimestamp() {
            const now = new Date();
            const formattedTime = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('last-updated').textContent = formattedTime;
        }

        function populateMainValueTooltip() {
            const tooltipContainer = document.getElementById('main-value-tooltip');
            if (!tooltipContainer) return;
            const cost = mainMeterData.totalKwh * ELECTRICITY_RATE_THB_PER_KWH;
            const co2 = mainMeterData.totalKwh * CO2_EMISSION_FACTOR_KG_PER_KWH;
            tooltipContainer.innerHTML = `
                <strong class="block text-base font-semibold mb-1">ข้อมูลเพิ่มเติม:</strong>
                <ul class="space-y-1">
                    <li><span class="font-semibold text-cyan-300">ค่าไฟประมาณ:</span> ${cost.toLocaleString('th-TH', { minimumFractionDigits: 2 })} บาท</li>
                    <li><span class="font-semibold text-cyan-300">Peak Demand:</span> ${mainMeterData.peakDemandKw.toLocaleString('th-TH')} kW</li>
                    <li><span class="font-semibold text-cyan-300">CO2 Footprint:</span> ${co2.toLocaleString('th-TH', { minimumFractionDigits: 2 })} kgCO₂e</li>
                </ul>
                <svg class="absolute text-gray-600 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
            `;
        }

        function populateMachineCards() {
            const grid = document.getElementById('machine-cards-grid');
            if (!grid) return;
            grid.innerHTML = ''; 

            machineData.forEach(machine => {
                const change = machine.previousDayKwh > 0 ? ((machine.currentKwh - machine.previousDayKwh) / machine.previousDayKwh) * 100 : 0;
                const changeColor = change > 0 ? 'text-red-400' : (change < 0 ? 'text-green-400' : 'text-gray-400');
                const changeIcon = change > 0 ? '▲' : (change < 0 ? '▼' : '–');
                const formattedChange = Math.abs(change).toFixed(1);

                let efficiencyTooltipHTML = '';
                if (machine.productionKg > 0) {
                    const efficiency = machine.currentKwh / machine.productionKg;
                    efficiencyTooltipHTML = `<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max invisible group-hover:visible bg-gray-600 text-white text-xs rounded-lg py-1 px-3 z-10">ประสิทธิภาพ: ${efficiency.toFixed(2)} kWh/Kg<svg class="absolute text-gray-600 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg></div>`;
                }

                const card = document.createElement('div');
                card.className = "bg-gray-700 p-4 rounded-lg text-center flex flex-col justify-between h-full cursor-pointer hover:bg-gray-600 transition-colors";
                card.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-white">${machine.name}</h3>
                        <div class="relative group inline-block my-1">
                            <p class="text-2xl font-bold text-amber-400">${new Intl.NumberFormat('th-TH').format(machine.currentKwh)}</p>
                            <p class="text-sm text-gray-400 -mt-1">kWh</p>
                            ${efficiencyTooltipHTML}
                        </div>
                    </div>
                    <div class="text-sm mt-2 ${changeColor}">
                        <span>${changeIcon} ${formattedChange}%</span>
                        <span class="text-gray-500"> เทียบกับเมื่อวาน</span>
                    </div>
                `;
                // Add dblclick event listener to navigate
                card.ondblclick = () => showMachineDetails(machine.name);
                grid.appendChild(card);
            });
        }
        
        function calculateAndDisplayDonutSummary() {
            const summaryContainer = document.getElementById('donut-chart-summary');
            if (!summaryContainer) return;
            const currentTotal = Object.values(internalConsumptionData.currentMonth).reduce((a, b) => a + b, 0);
            const previousTotal = Object.values(internalConsumptionData.previousMonth).reduce((a, b) => a + b, 0);
            if (previousTotal === 0) return;
            const change = ((currentTotal - previousTotal) / previousTotal) * 100;
            const changeColor = change > 0 ? 'text-red-400' : (change < 0 ? 'text-green-400' : 'text-gray-400');
            const changeIcon = change > 0 ? '▲' : (change < 0 ? '▼' : '–');
            const formattedChange = Math.abs(change).toFixed(1);
            summaryContainer.innerHTML = `<span class="${changeColor} font-semibold">${changeIcon} ${formattedChange}%</span><span class="text-gray-400"> เทียบกับเดือนก่อน</span>`;
        }

        // --- Chart Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateTimestamp();
            populateMainValueTooltip();
            populateMachineCards();
            calculateAndDisplayDonutSummary();
            setInterval(updateTimestamp, 1000);

            // Charts are initialized here...
             const pieCtx = document.getElementById('internalConsumptionPieChart').getContext('2d');
            new Chart(pieCtx, { type: 'doughnut', data: { labels: ['เครื่องจักร (Machinery)', 'สำนักงาน (Office)', 'Utility'], datasets: [ { label: 'เดือนปัจจุบัน', data: Object.values(internalConsumptionData.currentMonth), backgroundColor: ['rgba(34, 211, 238, 0.8)', 'rgba(99, 102, 241, 0.8)', 'rgba(139, 92, 246, 0.8)'], borderColor: '#1f2937' }, { label: 'เดือนก่อน', data: Object.values(internalConsumptionData.previousMonth), backgroundColor: ['rgba(251, 191, 36, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)'], borderColor: '#1f2937' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#D1D5DB', font: { family: "'Kanit', sans-serif" } } }, tooltip: { callbacks: { label: function(context) { const total = context.dataset.data.reduce((a, b) => a + b, 0); const value = context.parsed; const percentage = ((value / total) * 100).toFixed(2); return ` ${context.dataset.label} - ${context.label}: ${new Intl.NumberFormat('th-TH').format(value)} kWh (${percentage}%)`; } } } } } });
            const barCtx = document.getElementById('dailyUsageBarChart').getContext('2d');
            new Chart(barCtx, { type: 'bar', data: { labels: barChartData.map(d => d.machine), datasets: [{ label: 'การใช้พลังงาน (kWh)', data: barChartData.map(d => d.kwh), backgroundColor: 'rgba(251, 191, 36, 0.8)', borderColor: 'rgba(251, 191, 36, 1)', borderWidth: 1, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#D1D5DB', font: { family: "'Kanit', sans-serif" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#D1D5DB', font: { family: "'Kanit', sans-serif" } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { display: false } } } });
        });
    </script>
</body>
</html>





